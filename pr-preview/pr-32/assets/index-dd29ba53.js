import{s as g}from"./index-d475d2ea.js";const C=__STORYBOOK_MODULE_PREVIEW_API__.addons,A=__STORYBOOK_MODULE_CLIENT_LOGGER__.once,D=__STORYBOOK_MODULE_CLIENT_LOGGER__.logger,T=__STORYBOOK_MODULE_CORE_EVENTS__.FORCE_REMOUNT,L=__STORYBOOK_MODULE_CORE_EVENTS__.IGNORED_EXCEPTION,U=__STORYBOOK_MODULE_CORE_EVENTS__.SET_CURRENT_STORY,B=__STORYBOOK_MODULE_CORE_EVENTS__.STORY_RENDER_PHASE_CHANGED;var j=(n=>(n.DONE="done",n.ERROR="error",n.ACTIVE="active",n.WAITING="waiting",n))(j||{}),E={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},w,b=((w=g.FEATURES)==null?void 0:w.interactionsDebugger)!==!0,m={debugger:!b,start:!1,back:!1,goto:!1,next:!1,end:!1},y=new Error("This function ran after the play function completed. Did you forget to `await` it?"),N=n=>Object.prototype.toString.call(n)==="[object Object]",M=n=>Object.prototype.toString.call(n)==="[object Module]",Y=n=>{if(!N(n)&&!M(n))return!1;if(n.constructor===void 0)return!0;let s=n.constructor.prototype;return!(!N(s)||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)},P=n=>{try{return new n.constructor}catch{return{}}},p=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),I=(n,s=!1)=>{let l=(s?n.shadowCalls:n.calls).filter(i=>i.retain);if(!l.length)return;let c=new Map(Array.from(n.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:l.length,calls:l,callRefsByResult:c}},k=class{constructor(){this.initialized=!1,this.channel=C.getChannel(),this.state=g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let n=({storyId:e,isPlaying:r=!0,isDebugging:t=!1})=>{let o=this.getState(e);this.setState(e,{...p(),...I(o,t),shadowCalls:t?o.shadowCalls:[],chainedCallIds:t?o.chainedCallIds:new Set,playUntil:t?o.playUntil:void 0,isPlaying:r,isDebugging:t}),this.sync(e)};this.channel.on(T,n),this.channel.on(B,({storyId:e,newPhase:r})=>{let{isDebugging:t}=this.getState(e);this.setState(e,{renderPhase:r}),r==="preparing"&&t&&n({storyId:e}),r==="playing"&&n({storyId:e,isDebugging:t}),r==="played"&&this.setState(e,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(e,{isLocked:!1,isPlaying:!1})}),this.channel.on(U,()=>{this.initialized?this.cleanup():this.initialized=!0});let s=({storyId:e,playUntil:r})=>{this.getState(e).isDebugging||this.setState(e,({calls:o})=>({calls:[],shadowCalls:o.map(a=>({...a,status:"waiting"})),isDebugging:!0}));let t=this.getLog(e);this.setState(e,({shadowCalls:o})=>{var d;if(r||!t.length)return{playUntil:r};let a=o.findIndex(h=>h.id===t[0].callId);return{playUntil:(d=o.slice(0,a).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:d.id}}),this.channel.emit(T,{storyId:e,isDebugging:!0})},l=({storyId:e})=>{var o;let r=this.getLog(e).filter(a=>!a.ancestors.length),t=r.reduceRight((a,d,h)=>a>=0||d.status==="waiting"?a:h,-1);s({storyId:e,playUntil:(o=r[t-1])==null?void 0:o.callId})},c=({storyId:e,callId:r})=>{var O;let{calls:t,shadowCalls:o,resolvers:a}=this.getState(e),d=t.find(({id:u})=>u===r),h=o.find(({id:u})=>u===r);if(!d&&h&&Object.values(a).length>0){let u=(O=this.getLog(e).find(S=>S.status==="waiting"))==null?void 0:O.callId;h.id!==u&&this.setState(e,{playUntil:h.id}),Object.values(a).forEach(S=>S())}else s({storyId:e,playUntil:r})},i=({storyId:e})=>{var t;let{resolvers:r}=this.getState(e);if(Object.values(r).length>0)Object.values(r).forEach(o=>o());else{let o=(t=this.getLog(e).find(a=>a.status==="waiting"))==null?void 0:t.callId;o?s({storyId:e,playUntil:o}):_({storyId:e})}},_=({storyId:e})=>{this.setState(e,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(e).resolvers).forEach(r=>r())};this.channel.on(E.START,s),this.channel.on(E.BACK,l),this.channel.on(E.GOTO,c),this.channel.on(E.NEXT,i),this.channel.on(E.END,_)}getState(n){return this.state[n]||p()}setState(n,s){let l=this.getState(n),c=typeof s=="function"?s(l):s;this.state={...this.state,[n]:{...l,...c}},g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((s,[l,c])=>{let i=I(c);return i&&(s[l]=Object.assign(p(),i)),s},{});let n={controlStates:m,logItems:[]};this.channel.emit(E.SYNC,n),g.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(n){let{calls:s,shadowCalls:l}=this.getState(n),c=[...l];s.forEach((_,e)=>{c[e]=_});let i=new Set;return c.reduceRight((_,e)=>(e.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),e.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(e.interceptable||e.exception)&&!i.has(e.id)&&(_.unshift({callId:e.id,status:e.status,ancestors:e.ancestors}),i.add(e.id)),_),[])}instrument(n,s){if(!Y(n))return n;let{mutate:l=!1,path:c=[]}=s;return Object.keys(n).reduce((i,_)=>{let e=n[_];return typeof e!="function"?(i[_]=this.instrument(e,{...s,path:c.concat(_)}),i):typeof e.__originalFn__=="function"?(i[_]=e,i):(i[_]=(...r)=>this.track(_,e,r,s),i[_].__originalFn__=e,Object.defineProperty(i[_],"name",{value:_,writable:!1}),Object.keys(e).length>0&&Object.assign(i[_],this.instrument({...e},{...s,path:c.concat(_)})),i)},l?n:P(n))}track(n,s,l,c){var u,S,f,R;let i=((u=l==null?void 0:l[0])==null?void 0:u.__storyId__)||((R=(f=(S=g.__STORYBOOK_PREVIEW__)==null?void 0:S.selectionStore)==null?void 0:f.selection)==null?void 0:R.storyId),{cursor:_,ancestors:e}=this.getState(i);this.setState(i,{cursor:_+1});let r=`${e.slice(-1)[0]||i} [${_}] ${n}`,{path:t=[],intercept:o=!1,retain:a=!1}=c,d=typeof o=="function"?o(n,t):o,h={id:r,cursor:_,storyId:i,ancestors:e,path:t,method:n,args:l,interceptable:d,retain:a},O=(d&&!e.length?this.intercept:this.invoke).call(this,s,h,c);return this.instrument(O,{...c,mutate:!0,path:[{__callId__:h.id}]})}intercept(n,s,l){let{chainedCallIds:c,isDebugging:i,playUntil:_}=this.getState(s.storyId),e=c.has(s.id);return!i||e||_?(_===s.id&&this.setState(s.storyId,{playUntil:void 0}),this.invoke(n,s,l)):new Promise(r=>{this.setState(s.storyId,({resolvers:t})=>({isLocked:!1,resolvers:{...t,[s.id]:r}}))}).then(()=>(this.setState(s.storyId,r=>{let{[s.id]:t,...o}=r.resolvers;return{isLocked:!0,resolvers:o}}),this.invoke(n,s,l)))}invoke(n,s,l){let{callRefsByResult:c,renderPhase:i}=this.getState(s.storyId),_=t=>{var o,a;if(c.has(t))return c.get(t);if(t instanceof Array)return t.map(_);if(t instanceof Date)return{__date__:{value:t.toISOString()}};if(t instanceof Error){let{name:d,message:h,stack:O}=t;return{__error__:{name:d,message:h,stack:O}}}if(t instanceof RegExp){let{flags:d,source:h}=t;return{__regexp__:{flags:d,source:h}}}if(t instanceof g.window.HTMLElement){let{prefix:d,localName:h,id:O,classList:u,innerText:S}=t,f=Array.from(u);return{__element__:{prefix:d,localName:h,id:O,classNames:f,innerText:S}}}return typeof t=="function"?{__function__:{name:t.name}}:typeof t=="symbol"?{__symbol__:{description:t.description}}:typeof t=="object"&&((o=t==null?void 0:t.constructor)!=null&&o.name)&&((a=t==null?void 0:t.constructor)==null?void 0:a.name)!=="Object"?{__class__:{name:t.constructor.name}}:Object.prototype.toString.call(t)==="[object Object]"?Object.fromEntries(Object.entries(t).map(([d,h])=>[d,_(h)])):t},e={...s,args:s.args.map(_)};s.path.forEach(t=>{t!=null&&t.__callId__&&this.setState(s.storyId,({chainedCallIds:o})=>({chainedCallIds:new Set(Array.from(o).concat(t.__callId__))}))});let r=t=>{if(t instanceof Error){let{name:o,message:a,stack:d,callId:h=s.id}=t,O={name:o,message:a,stack:d,callId:h};if(this.update({...e,status:"error",exception:O}),this.setState(s.storyId,u=>({callRefsByResult:new Map([...Array.from(u.callRefsByResult.entries()),[t,{__callId__:s.id,retain:s.retain}]])})),s.ancestors.length)throw Object.prototype.hasOwnProperty.call(t,"callId")||Object.defineProperty(t,"callId",{value:s.id}),t;if(t!==y)throw D.warn(t),L}throw t};try{if(i==="played"&&!s.retain)throw y;let t=(l.getArgs?l.getArgs(s,this.getState(s.storyId)):s.args).map(a=>typeof a!="function"||Object.keys(a).length?a:(...d)=>{let{cursor:h,ancestors:O}=this.getState(s.storyId);this.setState(s.storyId,{cursor:0,ancestors:[...O,s.id]});let u=()=>this.setState(s.storyId,{cursor:h,ancestors:O}),S=!1;try{let f=a(...d);return f instanceof Promise?(S=!0,f.finally(u)):f}finally{S||u()}}),o=n(...t);return o&&["object","function","symbol"].includes(typeof o)&&this.setState(s.storyId,a=>({callRefsByResult:new Map([...Array.from(a.callRefsByResult.entries()),[o,{__callId__:s.id,retain:s.retain}]])})),this.update({...e,status:o instanceof Promise?"active":"done"}),o instanceof Promise?o.then(a=>(this.update({...e,status:"done"}),a),r):o}catch(t){return r(t)}}update(n){this.channel.emit(E.CALL,n),this.setState(n.storyId,({calls:s})=>{let l=s.concat(n).reduce((c,i)=>Object.assign(c,{[i.id]:i}),{});return{calls:Object.values(l).sort((c,i)=>c.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(n.storyId)}sync(n){let s=()=>{var o;let{isLocked:l,isPlaying:c}=this.getState(n),i=this.getLog(n),_=(o=i.filter(({ancestors:a})=>!a.length).find(a=>a.status==="waiting"))==null?void 0:o.callId,e=i.some(a=>a.status==="active");if(b||l||e||i.length===0){let a={controlStates:m,logItems:i};this.channel.emit(E.SYNC,a);return}let r=i.some(a=>["done","error"].includes(a.status)),t={controlStates:{debugger:!0,start:r,back:r,goto:!0,next:c,end:c},logItems:i,pausedAt:_};this.channel.emit(E.SYNC,t)};this.setState(n,({syncTimeout:l})=>(clearTimeout(l),{syncTimeout:setTimeout(s,0)}))}};function K(n,s={}){var l,c,i,_;try{let e=!1,r=!1;return(c=(l=g.window.location)==null?void 0:l.search)!=null&&c.includes("instrument=true")?e=!0:(_=(i=g.window.location)==null?void 0:i.search)!=null&&_.includes("instrument=false")&&(r=!0),g.window.parent===g.window&&!e||r?n:(g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new k),g.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(n,s))}catch(e){return A.warn(e),n}}export{K as i};
//# sourceMappingURL=index-dd29ba53.js.map
